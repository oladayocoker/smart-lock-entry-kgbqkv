
# Smart Lock Entry System - Raspberry Pi Backend Setup

## Hardware Requirements
- Raspberry Pi 4 (or newer)
- Pi Camera Module (v2 or v3)
- Servo Motor (for lock mechanism)
- Power supply for Raspberry Pi
- MicroSD card (16GB+)

## Software Installation

### 1. Update Raspberry Pi OS
```bash
sudo apt-get update
sudo apt-get upgrade -y
```

### 2. Install Python Dependencies
```bash
cd raspberry_pi
pip3 install -r requirements.txt
```

### 3. Enable Camera
```bash
sudo raspi-config
# Navigate to Interface Options > Camera > Enable
```

### 4. Configure GPIO
The lock motor uses GPIO pin 18 by default. You can change this in motor.py.

### 5. Test Components

Test Motor:
```bash
python3 motor.py
```

Test Camera:
```bash
python3 camera_stream.py
```

Test Motion Detection:
```bash
python3 motion_detection.py
```

## Finding Your Raspberry Pi IP Address

**IMPORTANT:** You need to find your Raspberry Pi's actual network IP address to connect from your mobile device.

### Method 1: Using hostname -I (Recommended)
```bash
hostname -I
```
This will show all IP addresses. Look for the one that starts with:
- 192.168.x.x (most common for home networks)
- 10.x.x.x (some routers use this)
- 172.16.x.x to 172.31.x.x (less common)

**IGNORE** addresses like:
- 127.0.0.1 or 127.0.1.1 (loopback - won't work from mobile)
- 169.254.x.x (link-local - won't work)

### Method 2: Using ip command
```bash
ip addr show
```
Look for the IP address under your network interface (usually eth0 for Ethernet or wlan0 for WiFi).

### Method 3: Using ifconfig
```bash
ifconfig
```
Look for "inet" address under eth0 (Ethernet) or wlan0 (WiFi).

### Method 4: Check your router
Log into your router's admin panel and look for connected devices. Find your Raspberry Pi in the list.

### Example Output
If you see:
```
192.168.1.150 127.0.1.1
```
Use **192.168.1.150** (NOT 127.0.1.1)

## Running the Server

### Development Mode
```bash
python3 server.py
```

The server will start on `0.0.0.0:8000`, which means it's accessible from any network interface.

### Production Mode (with Uvicorn)
```bash
uvicorn server:app --host 0.0.0.0 --port 8000
```

### Run as Background Service
Create a systemd service file:

```bash
sudo nano /etc/systemd/system/smartlock.service
```

Add the following content:
```
[Unit]
Description=Smart Lock Entry API
After=network.target

[Service]
Type=simple
User=pi
WorkingDirectory=/home/pi/raspberry_pi
ExecStart=/usr/bin/python3 /home/pi/raspberry_pi/server.py
Restart=always

[Install]
WantedBy=multi-user.target
```

Enable and start the service:
```bash
sudo systemctl enable smartlock.service
sudo systemctl start smartlock.service
sudo systemctl status smartlock.service
```

## Network Configuration

### Verify Server is Running
After starting the server, verify it's accessible:

1. From the Raspberry Pi itself:
```bash
curl http://localhost:8000
```

2. From another device on the same network:
```bash
curl http://YOUR_PI_IP:8000
```
Replace YOUR_PI_IP with the actual IP address (e.g., 192.168.1.150)

### Configure Firewall (if enabled)
```bash
sudo ufw allow 8000/tcp
```

### Access from Mobile App
1. Make sure your mobile device is on the **same WiFi network** as your Raspberry Pi
2. In the mobile app settings, enter the URL in this format:
   ```
   http://192.168.1.150:8000
   ```
   Replace `192.168.1.150` with your actual Raspberry Pi IP address

### Troubleshooting Network Connection

**Problem:** Mobile app can't connect to Raspberry Pi

**Solutions:**
1. Verify both devices are on the same WiFi network
2. Check the IP address is correct (not 127.0.0.1 or 127.0.1.1)
3. Verify the server is running: `sudo systemctl status smartlock.service`
4. Test from another device: `curl http://YOUR_PI_IP:8000`
5. Check firewall settings: `sudo ufw status`
6. Ping the Raspberry Pi from your mobile device (use a network tool app)

**Problem:** IP address keeps changing

**Solution:** Set a static IP address on your Raspberry Pi or configure DHCP reservation on your router.

## API Endpoints

- GET  /                    - Health check
- GET  /lock/state          - Get current lock state
- POST /lock/command        - Send lock/unlock command
- GET  /camera/live         - Live MJPEG camera stream
- GET  /clips               - List motion clips
- GET  /clips/{filename}    - Download specific clip
- GET  /activity            - Get activity logs
- WS   /ws/lock             - WebSocket for real-time updates

## Troubleshooting

### Camera Not Working
- Check camera cable connection
- Verify camera is enabled in raspi-config
- Test with: `libcamera-hello`

### GPIO Permission Issues
- Add user to gpio group: `sudo usermod -a -G gpio pi`
- Reboot: `sudo reboot`

### Port Already in Use
- Check running processes: `sudo lsof -i :8000`
- Kill process: `sudo kill -9 <PID>`

### Motion Detection Too Sensitive
- Adjust threshold in motion_detection.py
- Increase min_area parameter

## Security Recommendations

1. Change default credentials
2. Use HTTPS with SSL certificates
3. Implement authentication tokens
4. Set up firewall rules
5. Keep system updated
6. Use strong passwords
7. Enable fail2ban for SSH protection

## Performance Optimization

- Reduce camera resolution for better performance
- Adjust motion detection sensitivity
- Limit clip recording duration
- Clean up old clips regularly
- Monitor CPU and memory usage

## Maintenance

### View Logs
```bash
sudo journalctl -u smartlock.service -f
```

### Restart Service
```bash
sudo systemctl restart smartlock.service
```

### Clean Up Old Clips
```bash
find clips/ -type f -mtime +7 -delete
```

## Support

For issues and questions, check the project documentation or create an issue on GitHub.
